<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Register Participant</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-10">

    <!-- Aquí incluimos el formulario modular -->
    <section id="register-form">
        {% include "register_form.html" %}
    </section>

    <!-- Loading Spinner -->
    <div id="loading" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center">
        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24"></div>
    </div>

    <!-- Script de registro -->
    <script>
        const form = document.getElementById('registerForm');
        const loading = document.getElementById('loading');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            loading.classList.remove('hidden');
            successMessage.classList.add('hidden');
            errorMessage.classList.add('hidden');

            const data = {
                name: form.name.value,
                birth_date: form.birth_date.value,
                weight: parseFloat(form.weight.value),
                height: parseFloat(form.height.value),
                academy: form.academy.value,
                category: form.category.value,
                email: form.email.value,
                belt: form.belt.value || "white",
                torneo: form.torneo.value,
                payment_proof: null
            };

            try {
                const res = await fetch('https://vjfpbq4jbiz5uyarfu7z7ahlhi0xbhmi.lambda-url.us-east-1.on.aws/participants', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();

                if (!res.ok) {
                    errorMessage.textContent = result.detail?.message || JSON.stringify(result);
                    errorMessage.classList.remove('hidden');
                } else {
                    successMessage.textContent = result.message;
                    successMessage.classList.remove('hidden');
                    form.reset();
                }
            } catch (err) {
                console.error(err);
                errorMessage.textContent = "Error al registrar participante.";
                errorMessage.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
            }
        });
    </script>
    <script>
        const birthDateInput = document.querySelector('input[name="birth_date"]');
        const beltDiv = document.querySelector('select[name="belt"]').parentElement; // contenedor del select
        const beltSelect = document.querySelector('select[name="belt"]');

        const beltsKids = ["Blanco", "Gris", "Amarillo", "Naranja", "Verde"];
        const beltsAdults = ["Blanco", "Azul", "Morado", "Cafe", "Negro"];

        function calculateAge(date) {
            const today = new Date();
            const birthDate = new Date(date);
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
            return age;
        }

        function updateBelts() {
            const birthDate = birthDateInput.value;

            if (!birthDate) {
                // Ocultar cinturón si no hay fecha
                beltDiv.style.display = "none";
                beltSelect.innerHTML = "";
                return;
            }

            const age = calculateAge(birthDate);
            const options = age <= 15 ? beltsKids : beltsAdults;

            // Mostrar el div y llenar opciones
            beltDiv.style.display = "block";
            beltSelect.innerHTML = "";
            options.forEach(belt => {
                const option = document.createElement("option");
                option.value = belt.toLowerCase();
                option.textContent = belt;
                beltSelect.appendChild(option);
            });

            beltSelect.value = "blanca";
        }

        // Inicializar oculto
        beltDiv.style.display = "none";

        // Escuchar cambios en la fecha de nacimiento
        birthDateInput.addEventListener("change", updateBelts);
    </script>
    <style>
        .loader {
            border-top-color: #1DB954;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</body>
</html>