<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Register Participant</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-10">

    <!-- AquÃ­ incluimos el formulario modular -->
    <section id="register-form">
        {% include "register_form.html" %}
    </section>

    <!-- Loading Spinner -->
    <div id="loading" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center">
        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24"></div>
    </div>

    <!-- Modal de Ã©xito -->
    <div id="successModal" 
         class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-lg p-8 max-w-md w-full text-center transform scale-90 transition-transform duration-300">
            <h2 class="text-2xl font-bold text-green-600 mb-4">âœ… Registro Exitoso</h2>
            <p class="text-gray-700 mb-2">ðŸŽ‰ Haz iniciado tu registro con Ã©xito!</p>
            <p class="text-gray-800 font-semibold mb-6">
                Conserva tu AztlÃ¡n ID <span class="text-green-600" id="aztlanID"></span> para terminar tu registro.
            </p>
            <button id="closeModalBtn" 
                    class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                Cerrar
            </button>
        </div>
    </div>

    <script>
        const form = document.getElementById('registerForm');
        const loading = document.getElementById('loading');
        const errorMessage = document.getElementById('errorMessage');
        const successModal = document.getElementById('successModal');
        const aztlanIDSpan = document.getElementById('aztlanID');
        const closeModalBtn = document.getElementById('closeModalBtn');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            loading.classList.remove('hidden');
            errorMessage.classList.add('hidden');

            const data = {
                name: form.name.value,
                birth_date: form.birth_date.value,
                weight: parseFloat(form.weight.value),
                height: parseFloat(form.height.value),
                academy: form.academy.value,
                email: form.email.value,
                belt: form.belt.value || "white",
                torneo: form.torneo.value,
                payment_proof: null
            };

            try {
                const res = await fetch('https://vjfpbq4jbiz5uyarfu7z7ahlhi0xbhmi.lambda-url.us-east-1.on.aws/participants', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();

                if (!res.ok) {
                    errorMessage.textContent = result.detail?.message || JSON.stringify(result);
                    errorMessage.classList.remove('hidden');
                } else {
                    // Mostrar modal de Ã©xito con AztlÃ¡n ID
                    aztlanIDSpan.textContent = result.aztlan_id;
                    successModal.classList.remove('hidden');
                    form.reset();
                }
            } catch (err) {
                console.error(err);
                errorMessage.textContent = "Error al registrar participante.";
                errorMessage.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
            }
        });

        // BotÃ³n para cerrar modal
        closeModalBtn.addEventListener('click', () => {
            successModal.classList.add('hidden');
        });
    </script>

    <script>
        const birthDateInput = document.querySelector('input[name="birth_date"]');
        const beltDiv = document.querySelector('select[name="belt"]').parentElement;
        const beltSelect = document.querySelector('select[name="belt"]');

        const beltsKids = ["Blanco", "Gris", "Amarillo", "Naranja", "Verde"];
        const beltsAdults = ["Blanco", "Azul", "Morado", "Cafe", "Negro"];

        function calculateAge(date) {
            const today = new Date();
            const birthDate = new Date(date);
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
            return age;
        }

        function updateBelts() {
            const birthDate = birthDateInput.value;
            if (!birthDate) {
                beltDiv.style.display = "none";
                beltSelect.innerHTML = "";
                return;
            }

            const age = calculateAge(birthDate);
            const options = age <= 15 ? beltsKids : beltsAdults;

            beltDiv.style.display = "block";
            beltSelect.innerHTML = "";
            options.forEach(belt => {
                const option = document.createElement("option");
                option.value = belt.toLowerCase();
                option.textContent = belt;
                beltSelect.appendChild(option);
            });

            beltSelect.value = options[0].toLowerCase();
        }

        beltDiv.style.display = "none";
        birthDateInput.addEventListener("change", updateBelts);

        const picker = new Pikaday({
            field: birthDateInput,
            format: 'YYYY-MM-DD',
            yearRange: [1950, new Date().getFullYear()],
            maxDate: new Date(),
            firstDay: 1,
            i18n: {
                previousMonth : 'Mes anterior',
                nextMonth     : 'Mes siguiente',
                months        : ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'],
                weekdays      : ['Domingo','Lunes','Martes','MiÃ©rcoles','Jueves','Viernes','SÃ¡bado'],
                weekdaysShort : ['Dom','Lun','Mar','MiÃ©','Jue','Vie','SÃ¡b']
            },
            onSelect: function(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                birthDateInput.value = `${year}-${month}-${day}`;
                updateBelts();
            }
        });
    </script>
</body>
</html>