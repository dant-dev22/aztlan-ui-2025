<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Admin - Participantes</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">

<div class="max-w-6xl mx-auto bg-white p-6 rounded-xl shadow">
    <h1 class="text-2xl font-bold mb-4">Dashboard de Participantes</h1>

    <button id="fetchParticipantsBtn" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-semibold transition mb-4">
        Obtener Participantes
    </button>

    <div id="loading" class="hidden text-gray-700 mb-4">Cargando participantes...</div>
    <div id="errorMessage" class="hidden text-red-600 mb-4"></div>

    <div class="overflow-x-auto">
        <table class="min-w-full table-auto border-collapse border border-gray-300">
            <thead class="bg-gray-200">
                <tr>
                    <th class="border border-gray-300 px-3 py-2">Aztlan ID</th>
                    <th class="border border-gray-300 px-3 py-2">Nombre</th>
                    <th class="border border-gray-300 px-3 py-2">Email</th>
                    <th class="border border-gray-300 px-3 py-2">Academia</th>
                    <th class="border border-gray-300 px-3 py-2">Experiencia</th>
                    <th class="border border-gray-300 px-3 py-2">Cinturón</th>
                    <th class="border border-gray-300 px-3 py-2">Torneo</th>
                    <th class="border border-gray-300 px-3 py-2">Registrado</th>
                    <th class="border border-gray-300 px-3 py-2">Peso</th>
                    <th class="border border-gray-300 px-3 py-2">Comprobante de Pago</th>
                    <th class="border border-gray-300 px-3 py-2">Actualizar Estado</th>
                    <th class="border border-gray-300 px-3 py-2">Eliminar</th>
                </tr>
            </thead>
            <tbody id="participantsTableBody">
                <!-- Aquí se agregan los registros dinámicamente -->
            </tbody>
        </table>
    </div>
</div>

<script>
    const fetchBtn = document.getElementById('fetchParticipantsBtn');
    const tableBody = document.getElementById('participantsTableBody');
    const loading = document.getElementById('loading');
    const errorMessage = document.getElementById('errorMessage');

    const baseUrl = 'https://vjfpbq4jbiz5uyarfu7z7ahlhi0xbhmi.lambda-url.us-east-1.on.aws';

    fetchBtn.addEventListener('click', async () => {
        loading.classList.remove('hidden');
        errorMessage.classList.add('hidden');
        tableBody.innerHTML = '';

        try {
            const response = await fetch(`${baseUrl}/participants?torneo=aztlan-2025-b&limit=100`);
            if (!response.ok) {
                throw new Error(`Error al obtener participantes: ${response.statusText}`);
            }
            const participants = await response.json();

            if (participants.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="12" class="text-center p-4">No hay participantes</td></tr>`;
            } else {
                for (const p of participants) {
                    const tr = document.createElement('tr');

                    const spinner = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-gray-900 mx-auto"></div>`;
                    const isPaymentComplete = p.is_payment_complete || false;

                    tr.innerHTML = `
                        <td class="border border-gray-300 px-3 py-2">${p.aztlan_id}</td>
                        <td class="border border-gray-300 px-3 py-2">${p.name}</td>
                        <td class="border border-gray-300 px-3 py-2">${p.email}</td>
                        <td class="border border-gray-300 px-3 py-2">${p.academy}</td>
                        <td class="border border-gray-300 px-3 py-2">${p.experience}</td>
                        <td class="border border-gray-300 px-3 py-2">${p.belt || '-'}</td>
                        <td class="border border-gray-300 px-3 py-2">${p.torneo}</td>
                        <td class="border border-gray-300 px-3 py-2">${p.registered_at || '-'}</td>
                        <td class="border border-gray-300 px-3 py-2">${p.weight || '-'}</td>
                        <td class="border border-gray-300 px-3 py-2 text-center payment-cell">${spinner}</td>
                        <td class="border border-gray-300 px-3 py-2 text-center">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" class="payment-switch" ${isPaymentComplete ? 'checked' : ''}>
                                <span class="ml-2">${isPaymentComplete ? 'Completo' : 'Pendiente'}</span>
                            </label>
                        </td>
                        <td class="border border-gray-300 px-3 py-2 text-center">
                            <button class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded delete-btn">Eliminar</button>
                        </td>
                    `;
                    tableBody.appendChild(tr);

                    // Comprobante de pago
                    const paymentCell = tr.querySelector('.payment-cell');
                    fetch(`${baseUrl}/participants/${p.aztlan_id}/payment-proof-url`)
                        .then(res => (res.ok && res.status !== 204) ? res.json() : null)
                        .then(data => {
                            if (data && data.payment_proof_url) {
                                paymentCell.innerHTML = `<a href="${data.payment_proof_url}" target="_blank" class="text-blue-600 underline">Ver</a>`;
                            } else {
                                paymentCell.textContent = '-';
                            }
                        })
                        .catch(() => { paymentCell.textContent = 'Error'; });

                    // Switch de actualización de pago
                    const switchInput = tr.querySelector('.payment-switch');
                    switchInput.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const confirmUpdate = confirm('¿Estás seguro que quieres actualizar?');
                        if (!confirmUpdate) return;

                        const newStatus = switchInput.checked;
                        try {
                            const resp = await fetch(`${baseUrl}/participants/${p.aztlan_id}/payment`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ is_payment_complete: newStatus })
                            });
                            if (!resp.ok) throw new Error('Error actualizando el estado');
                            const result = await resp.json();
                            switchInput.nextElementSibling.textContent = result.is_payment_complete ? 'Completo' : 'Pendiente';
                            alert('Estado actualizado correctamente');
                        } catch (err) {
                            alert(err.message);
                            switchInput.checked = !switchInput.checked;
                        }
                    });

                    // Botón eliminar participante
                    const deleteBtn = tr.querySelector('.delete-btn');
                    deleteBtn.addEventListener('click', async () => {
                        const confirmDelete = confirm(`¿Deseas eliminar al participante ${p.name}?`);
                        if (!confirmDelete) return;

                        try {
                            const resp = await fetch(`${baseUrl}/participants/${p.aztlan_id}`, { method: 'DELETE' });
                            if (!resp.ok) throw new Error('Error eliminando participante');
                            const result = await resp.json();
                            alert(result.message);
                            location.reload(); // <-- recarga la página completa
                        } catch (err) {
                            alert(err.message);
                        }
                    }); 
                }
            }

        } catch (err) {
            errorMessage.textContent = err.message;
            errorMessage.classList.remove('hidden');
        } finally {
            loading.classList.add('hidden');
        }
    });
</script>

</body>
</html>
