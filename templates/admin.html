<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">

<div class="max-w-7xl mx-auto bg-white p-6 rounded-xl shadow relative">
    <h1 class="text-2xl font-bold mb-6">Participantes - Aztlan 2025 B</h1>

    <!-- Mensajes flotantes -->
    <div id="toastContainer" class="fixed top-4 right-4 space-y-2 z-50"></div>

    <!-- Buscador -->
    <div class="mb-4">
        <input type="text" id="searchInput" placeholder="Buscar participante..." class="w-full p-2 border border-gray-300 rounded-lg focus:border-orange-500 focus:ring focus:ring-orange-200 focus:ring-opacity-50">
    </div>

    <!-- Tabla -->
    <div class="overflow-x-auto">
        <table id="participantsTable" class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Academia</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cinturón</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha de Nacimiento</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aztlan ID</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Peso (kg)</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comprobante</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aprobado</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                </tr>
            </thead>
            <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                <!-- Se llenará dinámicamente -->
            </tbody>
        </table>
    </div>

    <!-- Paginación -->
    <div class="mt-4 flex justify-between items-center">
        <button id="prevPage" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">Anterior</button>
        <span id="pageInfo" class="text-gray-700"></span>
        <button id="nextPage" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600">Siguiente</button>
    </div>
</div>

<script>
const API_URL = "https://vjfpbq4jbiz5uyarfu7z7ahlhi0xbhmi.lambda-url.us-east-1.on.aws/participants?torneo=aztlan-2025-b&limit=1000";
const DELETE_URL_BASE = "https://vjfpbq4jbiz5uyarfu7z7ahlhi0xbhmi.lambda-url.us-east-1.on.aws/participants/";
const PAYMENT_PROOF_URL_BASE = "https://vjfpbq4jbiz5uyarfu7z7ahlhi0xbhmi.lambda-url.us-east-1.on.aws/participants/";
const UPDATE_PAYMENT_URL_BASE = "https://vjfpbq4jbiz5uyarfu7z7ahlhi0xbhmi.lambda-url.us-east-1.on.aws/participants/";

const searchInput = document.getElementById('searchInput');
const tableBody = document.getElementById('tableBody');
const prevPage = document.getElementById('prevPage');
const nextPage = document.getElementById('nextPage');
const pageInfo = document.getElementById('pageInfo');
const toastContainer = document.getElementById('toastContainer');

let participants = [];
let currentPage = 1;
const rowsPerPage = 10;

// Mostrar toast
function showToast(message, type = "success") {
    const toast = document.createElement('div');
    toast.className = `px-4 py-2 rounded-lg text-white ${type === "success" ? "bg-green-500" : "bg-red-500"} shadow-lg animate-fadeIn`;
    toast.textContent = message;
    toastContainer.appendChild(toast);
    setTimeout(() => {
        toast.classList.add('opacity-0', 'transition', 'duration-500');
        setTimeout(() => toast.remove(), 500);
    }, 3000);
}

// Obtener URL del comprobante
async function getPaymentProofUrl(aztlanId) {
    try {
        const res = await fetch(`${PAYMENT_PROOF_URL_BASE}${aztlanId}/payment-proof-url`);
        if (res.status === 204) return null;
        if (!res.ok) throw new Error(`Error: ${res.statusText}`);
        const data = await res.json();
        return data.payment_proof_url;
    } catch (err) {
        console.error(`No se pudo obtener comprobante para ${aztlanId}: ${err.message}`);
        return null;
    }
}

// Actualizar estado de pago
async function togglePaymentStatus(aztlanId, currentStatus) {
    if (!confirm("¿Estás seguro que quieres actualizar el estado del competidor?")) return currentStatus;

    try {
        const res = await fetch(`${UPDATE_PAYMENT_URL_BASE}${aztlanId}/payment`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_payment_complete: !currentStatus })
        });
        if (!res.ok) throw new Error(`Error: ${res.statusText}`);
        const data = await res.json();
        showToast(`Estado actualizado: ${data.is_payment_complete ? 'Aprobado' : 'No aprobado'}`, "success");
        return data.is_payment_complete;
    } catch (err) {
        showToast(`No se pudo actualizar: ${err.message}`, "error");
        return currentStatus;
    }
}

// Renderizar tabla
async function renderTable(data) {
    tableBody.innerHTML = '';
    const start = (currentPage - 1) * rowsPerPage;
    const pageData = data.slice(start, start + rowsPerPage);

    for (const p of pageData) {
        const paymentProofUrl = await getPaymentProofUrl(p.aztlan_id);
        const row = document.createElement('tr');

        row.innerHTML = `
            <td class="px-4 py-2 whitespace-nowrap">${p.name}</td>
            <td class="px-4 py-2 whitespace-nowrap">${p.academy}</td>
            <td class="px-4 py-2 whitespace-nowrap">${p.belt}</td>
            <td class="px-4 py-2 whitespace-nowrap">${p.birth_date}</td>
            <td class="px-4 py-2 whitespace-nowrap">${p.aztlan_id}</td>
            <td class="px-4 py-2 whitespace-nowrap">${p.weight}</td>
            <td class="px-4 py-2 whitespace-nowrap">
                ${paymentProofUrl ? `<a href="${paymentProofUrl}" target="_blank" class="text-blue-500 hover:underline">Comprobante de pago</a>` : 'Falta comprobante'}
            </td>
            <td class="px-4 py-2 whitespace-nowrap">
                <label class="inline-flex relative items-center cursor-pointer">
                    <input type="checkbox" class="sr-only approveSwitch" data-id="${p.aztlan_id}" ${p.is_payment_complete ? 'checked' : ''}>
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-orange-300 dark:peer-focus:ring-orange-800 peer-checked:bg-orange-500 transition-all"></div>
                </label>
            </td>
            <td class="px-4 py-2 whitespace-nowrap">
                <button class="deleteBtn bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg" data-id="${p.aztlan_id}">Delete</button>
            </td>
        `;
        tableBody.appendChild(row);
    }

    // Eventos Delete
    document.querySelectorAll('.deleteBtn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const aztlanId = e.target.dataset.id;
            if (!confirm(`¿Seguro que quieres eliminar el participante ${aztlanId}?`)) return;
            try {
                const res = await fetch(`${DELETE_URL_BASE}${aztlanId}`, { method: 'DELETE' });
                if (!res.ok) throw new Error(`Error: ${res.statusText}`);
                showToast(`Participante ${aztlanId} eliminado correctamente.`, "success");
                participants = participants.filter(p => p.aztlan_id !== aztlanId);
                renderTable(participants.filter(p =>
                    Object.values(p).some(v => String(v).toLowerCase().includes(searchInput.value.toLowerCase()))
                ));
            } catch (err) {
                showToast(`No se pudo eliminar: ${err.message}`, "error");
            }
        });
    });

    // Eventos Switch Aprobado
    document.querySelectorAll('.approveSwitch').forEach(async switchEl => {
        switchEl.addEventListener('change', async (e) => {
            const aztlanId = e.target.dataset.id;
            const currentStatus = e.target.checked;
            const updatedStatus = await togglePaymentStatus(aztlanId, !currentStatus);
            e.target.checked = updatedStatus;
        });
    });

    const totalPages = Math.ceil(data.length / rowsPerPage);
    pageInfo.textContent = `Página ${currentPage} de ${totalPages}`;
}

function updateTable() {
    const filtered = participants.filter(p =>
        Object.values(p).some(v => String(v).toLowerCase().includes(searchInput.value.toLowerCase()))
    );
    currentPage = 1;
    renderTable(filtered);
}

searchInput.addEventListener('input', updateTable);

prevPage.addEventListener('click', () => {
    if (currentPage > 1) {
        currentPage--;
        updateTable();
    }
});

nextPage.addEventListener('click', () => {
    const filtered = participants.filter(p =>
        Object.values(p).some(v => String(v).toLowerCase().includes(searchInput.value.toLowerCase()))
    );
    const totalPages = Math.ceil(filtered.length / rowsPerPage);
    if (currentPage < totalPages) {
        currentPage++;
        renderTable(filtered);
    }
});

async function loadParticipants() {
    try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error(`Error al cargar: ${res.statusText}`);
        participants = await res.json();
        renderTable(participants);
    } catch (err) {
        tableBody.innerHTML = `<tr><td colspan="9" class="px-4 py-2 text-center text-red-500">No se pudieron cargar los participantes: ${err.message}</td></tr>`;
    }
}

loadParticipants();
</script>

</body>
</html>